# QBuilder Proofs Directory

This directory contains persisted proofs that the QBuilder implementation meets its specification.

## Proof Files

| File | Purpose | Generated By |
|------|---------|--------------|
| `schema_compliance.txt` | Verifies schema matches canonical spec | `show_schema_compliance.py` |
| `fifo_ordering.txt` | Demonstrates FIFO claim ordering | `show_fifo.py` |
| `routing_table_validation.txt` | Validates routing table structure | `show_routing.py` |
| `crash_safety.md` | Documents crash-safety mechanism | Manual |

## Generating Proofs

Run each script to regenerate its proof file:

```bash
python proofs/show_schema_compliance.py
python proofs/show_fifo.py
python proofs/show_routing.py
```

## Acceptance Criteria Verified

Per the canonical specification:

1. ✓ `discovery_queue` has NO `root_type`, `root_path`, `root_name`, counters
2. ✓ `build_queue` has NO `relpath`, `cvid` duplication, NO `steps_completed`
3. ✓ `build_queue` items bind to fingerprint fields (`work_file_mtime`, `work_file_size`, `work_file_hash`)
4. ✓ FIFO claiming uses `build_id` monotonic ordering
5. ✓ No scheduling uses `needs_*` flags or "missing artifact" inference

## Crash-Safety Guarantee

The two-queue model with leased claims provides crash-safety:

- **Claim**: Atomic `UPDATE...RETURNING` prevents races
- **Lease**: `lease_expires_at` allows recovery from dead workers
- **Fingerprint**: Work bound to exact bytes prevents stale artifact storage
- **FIFO**: `ORDER BY build_id ASC` ensures fair scheduling

See [crash_safety.md](crash_safety.md) for detailed proof.
