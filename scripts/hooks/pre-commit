#!/bin/sh
#
# Pre-commit hook for ck3raven policy enforcement
# 
# This hook BLOCKS commits that fail policy validation.
# It is the PRIMARY enforcement mechanism - not advisory.
#
# To bypass in emergencies: git commit --no-verify
# (This should be rare and documented)

set -e  # Exit on first failure

REPO_ROOT="$(git rev-parse --show-toplevel)"
VENV_PYTHON="$REPO_ROOT/../.venv/Scripts/python.exe"

# Determine which Python to use
if [ -f "$VENV_PYTHON" ]; then
    PYTHON="$VENV_PYTHON"
else
    PYTHON="python"
fi

echo "üîç Running Code-Diff Guard..."
"$PYTHON" "$REPO_ROOT/scripts/guards/code_diff_guard.py" --base HEAD
CDG_EXIT=$?

if [ $CDG_EXIT -ne 0 ]; then
    echo "‚ùå Code-Diff Guard failed. Commit blocked."
    exit 1
fi
echo "‚úÖ Code-Diff Guard passed"

echo ""
echo "üîç Running Policy Validation..."
"$PYTHON" "$REPO_ROOT/scripts/pre-commit-policy-check.py"
POLICY_EXIT=$?

if [ $POLICY_EXIT -ne 0 ]; then
    echo "‚ùå Policy validation failed. Commit blocked."
    exit 1
fi
echo "‚úÖ Policy validation passed"

exit 0
